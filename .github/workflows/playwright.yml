name: VRT Tests
on:
  pull_request:
    types: [labeled, synchronize]

# é€£ç¶špushå¯¾ç­–
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vrt-docker:
    if: contains(github.event.pull_request.labels.*.name, 'vrt')
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    timeout-minutes: 60

    env:
      PORT: 3000
      FRONT_CONTAINER: next
      PLAYWRIGHT_CONTAINER_NAME: playwright

    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 1 # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã ã‘ã§ã‚ˆã„ã®ã§

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      # æš«å®šã§ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿åˆ©ç”¨
      - name: Cache Front Docker Layers
        uses: docker/build-push-action@v4
        with:
          load: true
          push: false
          context: .
          file: ./infra/next/Dockerfile
          cache-from: type=gha,scope=next
          cache-to: type=gha,mode=max,scope=next

      # æš«å®šã§ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿åˆ©ç”¨
      - name: Cache Playwright Docker Layers
        uses: docker/build-push-action@v4
        with:
          load: true
          push: false
          context: .
          file: ./infra/playwright/Dockerfile
          cache-from: type=gha,scope=playwright
          cache-to: type=gha,mode=max,scope=playwright

        # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•+ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Start Next Containers and Take Screenshot
        run: |
          docker compose up next -d
          docker compose run playwright bash -c "chmod +x ./wait.sh && ./wait.sh next:3000 && npm run ss-after"

      - name: Chmod Playwright Directory
        run: sudo chmod -R 777 playwright

      - name: Restore Base Screenshots Cache
        uses: actions/cache@v3
        id: base-ss-cache
        with:
          path: playwright/vrt/before
          key: screenshot-base-${{ github.event.pull_request.base.sha }}

      # baseãƒ–ãƒ©ãƒ³ãƒã®frontã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      - name: Checkout Base Branch
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{github.base_ref}}
          sparse-checkout: |
            front
          sparse-checkout-cone-mode: false
          path: base-front

      - name: npm list front
        run: |
          docker compose exec -T next npm list

      # baseãƒ–ãƒ©ãƒ³ãƒã®frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€å…ƒã®base-frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
      - name: Copy Base-Front To Front
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: |
          id
          ls -la front
          sudo rm -rf front
          sudo mv base-front/front front
          sudo rm -rf base-front
          ls -la front

        # frontã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•
      - name: Restart Front Container
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: |
          docker compose up next -d --force-recreate

      - name: npm list front
        run: |
          ls -la front
          docker compose exec -T next npm list

      # beforeã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
      - name: Take Before Screenshots
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: docker compose run playwright bash -c "./wait.sh next:3000 && npm run ss-before"

      # reg-cliã«ã‚ˆã‚‹æ¯”è¼ƒ
      - name: Compare Screenshots
        run: docker compose run playwright bash -c "npm run reg"
        continue-on-error: true

      - name: Upload VRT Reports
        uses: actions/upload-artifact@v4
        id: upload-vrt-reports
        with:
          name: screen-shot ${{ github.sha }} # gitshaã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
          path: |
            playwright/vrt
          retention-days: 30 # ã¨ã‚Šã‚ãˆãšï¼‘ã‚«æœˆä¿å­˜

      # AWSã¸ã®èªè¨¼
      - name: Configure AWS credentials from Test account
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: "ap-southeast-2" # ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          role-to-assume: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/oidc-example-gha" # ä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«ã® ARN "#self hosted runnnerã®å ´åˆã¯ä¸è¦"

      # s3ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Deploy VRT Reports to S3
        working-directory: ./playwright/vrt
        run: aws s3 cp . s3://ci-cd-demo-reg-suit-vrt-screenshots/vrt-cicd-demo/${{github.sha}} --recursive

      - name: Comment Results on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
            const reportPath = 'playwright/vrt/reports/report.json';
            const json = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            // VRTçµæœæŠ½å‡º
            const result = {
              changed: json.failedItems.length.toString(),
              newItems: json.newItems.length.toString(),
              deleted: json.deletedItems.length.toString(),
              passed: json.passedItems.length.toString(),
            };


            // Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
            const markdown = await core.summary
              .addHeading(`ğŸ“¸ Visual Regression Test Results`, 3)
              .addTable([
                ["ğŸ”´ Changed Items",  "ğŸŸ¡ New Items",        "ğŸŸ¤ Deleted Items",  "ğŸ”µ Passed Items"],
                [result.changed, result.newItems, result.deleted, result.passed]
              ])
              .addLink('You can download report from here', 
               `${{steps.upload-vrt-reports.outputs.artifact-url}}`)
              .stringify();

            // ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½œæˆ
            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: markdown,
            };

            // ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿
            await github.rest.issues.createComment(params);

      # ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
      - name: Cleanup Docker Environment
        if: always()
        run: docker compose down --rmi all --volumes --remove-orphans
