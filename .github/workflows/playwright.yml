name: VRT Tests
on:
  pull_request:
    types: [labeled, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  # job id
  vrt-docker:
    if: contains(github.event.pull_request.labels.*.name, 'vrt')
    timeout-minutes: 60
    runs-on: ubuntu-20.04
    steps:
      - run: echo "Running Playwright Tests"

      - name: Checkout Current Branch
        uses: actions/checkout@v4 # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        with:
          ref: ${{ github.ref }} # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®š
          fetch-depth: 0 # ãƒ•ã‚§ãƒƒãƒã™ã‚‹ã‚³ãƒŸãƒƒãƒˆã®æ·±ã•ã‚’æŒ‡å®š

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      #   # ãƒã‚¤ãƒ³ãƒˆ 2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã™ã‚‹
      # - name: Cache Next Docker Layers
      #   uses: actions/cache@v2
      #   with:
      #     path: /tmp/.buildx-cache-next
      #     # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
      #     key: ${{ github.ref }}-${{ github.sha }}-next
      #     # keyãŒãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã«åˆ©ç”¨ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
      #     restore-keys: |
      #       ${{ github.ref }}
      #       refs/head/master

      #   # ãƒã‚¤ãƒ³ãƒˆ 2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã™ã‚‹
      # - name: Cache Playwright Docker Layers
      #   uses: actions/cache@v2
      #   with:
      #     path: /tmp/.buildx-cache-playwright
      #     key: ${{ github.ref }}-${{ github.sha }}-playwright
      #     restore-keys: |
      #       ${{ github.ref }}
      #       refs/head/master

      # - name: Cache Next Docker Layers Local
      #   uses: docker/build-push-action@v4
      #   with:
      #     load: true
      #     push: false
      #     context: .
      #     builder: ${{ steps.buildx.outputs.name }}
      #     file: ./infra/next/Dockerfile
      #     tags: my-app-react-reg-suit-next
      #     cache-from: type=local,src=/tmp/.buildx-cache-next
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new-next,mode=max

      # - name: Cache Playwright Docker Layers Local
      #   uses: docker/build-push-action@v4
      #   with:
      #     load: true
      #     push: false
      #     context: .
      #     builder: ${{ steps.buildx.outputs.name }}
      #     file: ./infra/playwright/Dockerfile
      #     tags: my-app-react-reg-suit-playwright
      #     cache-from: type=local,src=/tmp/.buildx-cache-playwright
      #     cache-to: type=local,dest=/tmp/.buildx-cache-new-playwright,mode=max

      # ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å¿…è¦ã«å¿œã˜ã¦åˆ©ç”¨ã™ã‚‹ã€‚æš«å®šã§ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿åˆ©ç”¨
      - name: Cache Front Docker Layers
        uses: docker/build-push-action@v4
        with:
          load: true
          push: false
          context: .
          file: ./infra/next/Dockerfile
          # tags: my-app-react-reg-suit-next
          cache-from: type=gha,scope=next
          cache-to: type=gha,mode=max,scope=next

      # ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å¿…è¦ã«å¿œã˜ã¦åˆ©ç”¨ã™ã‚‹ã€‚æš«å®šã§ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿åˆ©ç”¨
      - name: Cache Playwright Docker Layers
        uses: docker/build-push-action@v4
        with:
          load: true
          push: false
          context: .
          file: ./infra/playwright/Dockerfile
          # tags: my-app-react-reg-suit-playwright
          cache-from: type=gha,scope=playwright
          cache-to: type=gha,mode=max,scope=playwright

      - name: Start Next Containers
        run: docker compose up next -d

      - name: who am i
        run: whoami

      - name: Take Screenshot Of The Current State
        run: docker compose run playwright bash -c "chmod +x ./wait.sh && ./wait.sh next:3000 && npm run ss-after"

      - name: Chmod Playwright Directory
        run: sudo chmod -R 777 playwright

      - name: Restore Base Screenshots Cache
        uses: actions/cache@v3
        id: base-ss-cache
        with:
          path: playwright/vrt/before
          key: screenshot-base-${{ github.event.pull_request.base.sha }}

      # baseãƒ–ãƒ©ãƒ³ãƒã®frontã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      - name: Checkout Base Branch
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4 # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        with:
          ref: ${{github.base_ref}} # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®š
          # frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã ã‘ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          sparse-checkout: |
            front
          sparse-checkout-cone-mode: false
          path: base-front

      # baseãƒ–ãƒ©ãƒ³ãƒã®frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€å…ƒã®base-frontãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
      - name: Copy Base-Front To Front
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: |
          sudo rm -rf front
          sudo mv base-front/front front
          sudo rm -rf base-front

        # frontã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•
      - name: Restart Front Container
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: docker compose restart next

      # beforeã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
      - name: Take Before Screenshots
        if: steps.base-ss-cache.outputs.cache-hit != 'true'
        run: docker compose run playwright bash -c "chmod +x ./wait.sh && ./wait.sh next:3000 && npm run ss-before"
        continue-on-error: true

      # reg-cliã«ã‚ˆã‚‹æ¯”è¼ƒ
      - name: Compare Screenshots
        run: docker compose run playwright bash -c "npm run reg"
        continue-on-error: true

      - name: Upload VRT Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screen-shot ${{ github.sha }} # gitshaã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
          path: |
            playwright/vrt
          retention-days: 30

      # - name: Fix Permissions Of VRT Reports
      #   run: |
      #     sudo chmod -c -R +rX "playwright/vrt" | while read line; do
      #       echo "::warning title=Invalid file permissions automatically fixed::$line"
      #     done

      # - name: Upload VRT Reports To Page Artifact
      #   uses: actions/upload-pages-artifact@v3.0.1
      #   if: always()
      #   with:
      #     name: screen-shot ${{ github.sha }} # gitshaã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
      #     retention-days: 30
      #     path: playwright/vrt

      #   # Temp fix
      #   # https://github.com/docker/build-push-action/issues/252
      #   # https://github.com/moby/buildkit/issues/1896
      # - name: Move Cache
      #   run: |
      #     rm -rf /tmp/.buildx-cache-next
      #     rm -rf /tmp/.buildx-cache-playwright
      #     mv /tmp/.buildx-cache-new-next /tmp/.buildx-cache-next
      #     mv /tmp/.buildx-cache-new-playwright /tmp/.buildx-cache-playwright

      - name: Comment Results on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
            const reportPath = 'playwright/vrt/reports/report.json';
            const log = fs.readFileSync(reportPath, 'utf8');
            const json = JSON.parse(log);

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
            const stats = {
              changed: json.failedItems.length.toString(),
              newItems: json.newItems.length.toString(),
              deleted: json.deletedItems.length.toString(),
              passing: json.passedItems.length.toString(),
            };

            // Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
            const markdown = await core.summary
              .addHeading('ğŸ“¸ Visual Regression Test Results', 3)
              .addTable([
                ["ğŸ”´ Changed",  "ğŸŸ¡ New",        "ğŸŸ¤ Deleted",  "ğŸ”µ Passing"],
                [stats.changed, stats.newItems, stats.deleted, stats.passing]
              ])
              .addHeading("ğŸ“Š Download Report", 3)
              .addLink('You can download the report from the artifact here', 
                `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`)
              .stringify();

            // ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½œæˆ
            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: markdown,
            };

            // ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿
            await github.rest.issues.createComment(params);

      # å‰ã®ã‚¸ãƒ§ãƒ–ã®æˆåŠŸå¤±æ•—ã«é–¢ä¿‚ãªãå®Ÿè¡Œ
      - name: Cleanup Docker Environment
        if: always()
        run: docker compose down --rmi all --volumes --remove-orphans

  # deploy-to-github-pages:
  #   runs-on: ubuntu-latest
  #   needs: vrt-docker
  #   # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
  #   permissions:
  #     pages: write # to deploy to Pages
  #     id-token: write # to verify the deployment originates from an appropriate source

  #   # Deploy to the github-pages environment
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deployment.outputs.page_url }}

  #   steps:
  #     - name: Deploy To GitHub Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v4 # or specific "vX.X.X" version tag for this action
  #       with:
  #         artifact_name: screen-shot ${{ github.sha }}
